#! /bin/sh

cmd="$1"
test -z "$cmd" || shift

taskdir="$HOME/.tsk"

task_template="tags: 
title: 
due: 
description:
"

helpmsg() {
name=`basename $0`
echo "
$name ls | l [query]
    lists and searchs tasks
    
$name add | a
    adds a new task

$name edit | e task_id
    open EDITOR to edit a task, even if it not exists

$name rm | r task_id
    removes a task

$name git | g [git_args]
    runs 'git git_args' in the task directory

$name sync | y
    syncs: commit changes and pull/push with git

$name clean
    purge your tasks, use with caution
"
}

is_task_list_empty() {
    cd $taskdir
    ls -1 *.md &>/dev/null
    RET=$?
    cd - &>/dev/null
    test ! $RET = 0
}

get_task_file_list() {
    is_task_list_empty && return
    cd $taskdir
    ls -1 *.md
    cd - &>/dev/null
}

get_task_id_list() {
    get_task_file_list | sed 's/\.md$//g' | sort -rn
}

get_task_id_from_filename() {
    local filename="$1"
    basename "$filename" | sed 's/\.md$//'
}

get_task_field() {
    local task_id="$1"
    local field_name="$2"
    cat $taskdir/$task_id.md | grep "^$field_name:" | sed "s/^$field_name://"
}

list_tasks() {
    for task_id in `get_task_id_list`; do
        title=`get_task_field $task_id 'title'`
        tags=`get_task_field $task_id 'tags'`
        tags=`for tag in $tags; do echo -n "[$tag] "; done`
        if echo -n "$task_id" |  grep '^[0-9]$' &>/dev/null; then
            echo "$task_id:  $tags$title"
        else
            echo "$task_id: $tags$title"
        fi
    done
}

is_there_a_task_with_id() {
    local task_id_to_check="$1"
    for task_id in `get_task_id_list`; do
        if [ "$task_id" = "$task_id_to_check" ]; then
            return 0
        fi
    done
    return 1
}

get_first_free_id() {
    counter=1
    while true; do
        if ! is_there_a_task_with_id $counter; then
            echo $counter
            return
        fi
        counter=`expr $counter + 1`
    done
}

get_new_id() {
    task_file_list=`get_task_file_list`
    if test -z "$task_file_list"; then
        echo 1
    else
        get_first_free_id
    fi
}

add_task() {
    newid=`get_new_id`
    newfile=$taskdir/$newid.md
    echo "$task_template" > $newfile
    $EDITOR $newfile
}

edit_task() {
    local task_id="$1"
    $EDITOR $taskdir/$task_id.md
}

remove_task() {
    local task_id="$1"
    task_file="$taskdir/$task_id.md"
    if test ! -f $task_file; then
        echo "task $task_id does not exists"
        return
    fi
    title=`get_task_field $task_id 'title'`
    echo -n "remove task $task_id [$title] (y/n)? "
    read c
    if test "$c" = "y" || test "$c" = "Y"; then
        rm -f $task_file
        echo "task $task_id removed"
    else
        echo "aborted"
    fi
}

clean_tasks() {
    echo -n "delete all tasks (y/n)? "
    read c
    if test "$c" = "y" || test "$c" = "Y"; then
        rm -f $taskdir/*.md
        echo "tasks removed"
    else
        echo "aborted"
    fi
}

test -d $taskdir || mkdir -p $taskdir

if [ "$cmd" = "ls" ] || [ "$cmd" = "l" ]; then
    list_tasks

elif [ "$cmd" = "add" ] || [ "$cmd" = "a" ]; then
    add_task

elif [ "$cmd" = "edit" ] || [ "$cmd" = "e" ]; then
    edit_task $1

elif [ "$cmd" = "rm" ] || [ "$cmd" = "r" ]; then
    remove_task $1

elif [ "$cmd" = "git" ] || [ "$cmd" = "g" ]; then
    cd $taskdir
    git $@

elif [ "$cmd" = "sync" ] || [ "$cmd" = "y" ]; then
    cd $taskdir
    git status | grep 'nothing to commit' &>/dev/null
    test $? = 1 && git add -A && git commit -am 'tsk autosync'
    git pull && git push

elif [ "$cmd" = "clean" ]; then
    clean_tasks

else
    helpmsg
fi
